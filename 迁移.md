# 嵌入式迁移记录（Youtube 工作流 → 主模板）

## 背景
本仓库原为 mksaas 模板主工程（含登录、支付、博客、协议、营销页等）。  
需求是将「youtube‑工作流」作为功能模块嵌入进来，并保持主工程能力完整可用。

## 目标（已确认）
1. `/` 显示 Youtube 工作流首页。  
2. 主工程其它页面继续可访问：`/home`（原模板首页）、`/pricing`、`/blog`、`/terms`、`/auth/login` 等。  
3. Youtube 工作流公开可用；登录后可增强能力（后续接入主工程 session）。  
4. Youtube API 全部加前缀：`/api/youtube/*`，避免与主工程 API 冲突。  
5. 主工程升级到稳定 Next 15.x + React 19.1。

## 关键改动

### 1) 恢复主工程基线
- 用 `/_backup_before_youtube/` 恢复了模板原始结构与功能。
- 保留了 `.env.local`（你的真实 R2/AI 凭证）。

### 2) 引入 Youtube 代码为独立模块
- 新增目录 `src/youtube/*`，包含：
  - `src/youtube/components/*`
  - `src/youtube/constants/*`
  - `src/youtube/data/*`
  - `src/youtube/lib/*`
  - `src/youtube/providers/*`
  - `src/youtube/server-init.ts`
- 新增别名：`tsconfig.json` 增加 `@youtube/* -> src/youtube/*`。
- Youtube 内部原 `@/lib`/`@/components`/`@/constants`/`@/providers`/`@/data` 引用已替换为 `@youtube/*`；  
  UI 组件仍复用主工程的 `@/components/ui/*`。

### 3) 路由与页面挂载
- 新增 Youtube 路由组 `src/app/[locale]/(youtube)/*`：
  - `src/app/[locale]/(youtube)/page.tsx`：根路由 `/` → Youtube 首页（`MainDashboard`）。
  - `src/app/[locale]/(youtube)/video/create/page.tsx`：保留 Youtube 的创建视频页 `/video/create`。
  - `src/app/[locale]/(youtube)/layout.tsx`：挂载 Youtube 自身 providers，并设置 `dynamic = 'force-dynamic'`。
  - `src/app/[locale]/(youtube)/error.tsx`、`not-found.tsx`、`500/page.tsx`：Youtube 专属错误页。
- 模板原营销首页从 `/` 迁到 `/home`：
  - `src/app/[locale]/(marketing)/(home)/page.tsx` → `src/app/[locale]/(marketing)/home/page.tsx`。
  - `src/routes.ts` 新增 `Routes.MarketingHome = '/home'`，并把 `/#features`、`/#faq` 等锚点改为 `/home#...`。

### 4) API 命名空间化
- Youtube 的所有 API 迁到 `src/app/api/youtube/*`（结构与原项目一致）。
- Youtube 客户端与内部 fetch 统一加前缀：
  - `src/youtube/lib/api.ts`
  - `src/youtube/lib/r2/r2Upload.ts`
  - `src/youtube/components/R2Uploader.tsx`
  - `src/youtube/components/dashboard/*`
  - `src/youtube/lib/hooks/use-video-generation.ts`

### 5) 依赖与版本对齐
- `package.json`：
  - Next 升级到稳定 15.x（最终安装为 `next@15.5.9`；镜像仓库无 15.6 稳定版）。
  - React/ReactDOM 升级到 `19.1.0`。
  - 补齐 Youtube 依赖：`@aws-sdk/*`、`axios`、`p-limit`、`papaparse`、`sharp`、`undici`。
  - 对齐若干重叠库版本（Radix、tanstack/react-query、lucide-react、sonner、tailwind-merge、zustand）。

### 6) 本地验证脚本
- 新增 `scripts/smoke-dev.mjs`，并在 `package.json` 增加 `smoke:dev`。
- 脚本会启动 dev 后依次请求：
  - `/`（Youtube 首页）
  - `/home`（模板营销首页）
  - `/pricing`、`/blog`、`/terms`、`/auth/login`

## 运行方式
```bash
pnpm install
pnpm dev
```
访问：
- `http://localhost:3000/` → Youtube 工作流
- `http://localhost:3000/home` → 模板首页

Smoke 测试：
```bash
pnpm run smoke:dev
```

## 已知提示
- Better Auth 会警告 github/google 社交登录缺少 key（不影响普通登录）；需要的话在 `.env.local` 补齐即可。
- pnpm peer dependency warning（部分库尚未声明 React 19 支持），目前不影响启动。
- Next 提示 workspace root 推断锁文件冲突（你用户目录下另一个 `package-lock.json` 导致），不影响开发。

## 下一步（可选）
- 接入“登录后增强能力”：让 Youtube 模块读取主工程 session、按用户保存配置/额度、控制并发等。
- 如果要用模板导航进入工作流，可在导航配置新增入口指向 `/` 或 `/home` 返回模板首页。

