# 视频生成工作流功能说明

## 功能概述

视频生成工作流是一个完整的端到端工作流程，从文本脚本开始，经过分镜生成、图片生成、编辑排序，最终输出可用于现有批量图生视频模块的JSON数据。

## 主要功能

### 1. 脚本输入
- 支持中文文本输入
- 字符数限制：4000字符
- 自动截断超长内容并提示成本风险

### 2. 分镜生成
- 使用AI模型生成分镜JSON
- 默认1-50个镜头，智能计算数量
- 输出格式：`[{shot_id, image_prompt}]`
- 支持Schema验证

### 3. 批量图片生成（Mock）
- 模拟批量图片生成
- 支持9:16比例（1080×1920）
- 并发控制：3-4个
- 超时设置：90秒
- 指数退避重试机制

### 4. 图片编辑与排序
- 拖拽排序功能
- 双击删除图片
- 本地上传补图
- 一键重排编号
- 支持撤销操作

### 5. 视频提示词生成
- 基于脚本和图片顺序生成视频提示词
- 输出格式：`[{shot_id, image_prompt}]`
- 严格按输入顺序输出

### 6. 导出功能
- JSON格式导出
- CSV格式导出（兼容现有模块）
- 复制到剪贴板
- 支持导入已有CSV文件

## API接口

### POST /api/shot-prompts
生成分镜JSON
```json
{
  "script": "故事脚本"
}
```

### POST /api/images/batch
批量生成图片
```json
{
  "shots": [{"shot_id": "shot_001", "image_prompt": "..."}],
  "aspectRatio": "9:16"
}
```

### POST /api/upload
上传图片文件
```
multipart/form-data
```

### POST /api/reorder
重排编号
```json
{
  "images": [{"shot_id": "shot_001", "url": "...", "source": "generated"}]
}
```

### POST /api/video-prompts
生成视频提示词
```json
{
  "script": "故事脚本",
  "images": [{"shot_id": "shot_001", "url": "..."}]
}
```

## 错误处理

### 错误码
- `E_EMPTY_INPUT`: 输入为空
- `E_INPUT_TOO_LONG`: 输入过长
- `E_TIMEOUT`: 请求超时
- `E_MODEL_RATE_LIMIT`: 模型限流
- `E_JSON_SCHEMA`: Schema验证失败
- `E_UPLOAD_TYPE`: 不支持的文件类型
- `E_UPLOAD_SIZE`: 文件过大
- `E_DUPLICATE_URL`: 重复URL

### 重试机制
- 最大重试次数：3次
- 指数退避：200ms × 1.6^attempt
- 最大延迟：5秒

## 使用流程

1. **输入脚本**：在文本框中输入故事脚本
2. **生成分镜**：点击"生成分镜"按钮，AI会生成分镜JSON
3. **批量出图**：点击"批量生成图片"按钮，模拟生成图片
4. **编辑排序**：拖拽排序图片，上传补图，删除不需要的图片
5. **重排编号**：点击"重排编号"按钮，重新分配shot_id
6. **生成视频提示词**：点击"生成视频提示词"按钮
7. **导出结果**：复制JSON或下载CSV文件

## CSV格式

### 分镜CSV（CSV-A）
```csv
shot_id,image_prompt,aspect
shot_001,"[主体]...",9:16
```

### 视频提示词CSV（CSV-B）
```csv
shot_id,image_prompt
shot_001,"镜头推进，角色开心大笑..."
```

## 技术特性

- **零侵入对接**：与现有批量文生图和批量图生视频模块完全兼容
- **Schema验证**：所有API返回数据都经过JSON Schema验证
- **错误恢复**：支持失败重试和错误恢复
- **本地存储**：上传的图片保存在本地uploads目录
- **响应式设计**：支持移动端和桌面端

## 注意事项

1. 所有图片比例固定为9:16（1080×1920）
2. shot_id格式必须为shot_001、shot_002等
3. 上传的图片会自动分配shot_upload_001等ID
4. 重排编号会重新分配连续的shot_id
5. 视频提示词生成前会自动执行重排编号

## 扩展功能

- 支持CSV导入/导出
- 支持JSON格式导入/导出
- 支持拖拽排序
- 支持批量操作
- 支持错误重试
- 支持进度显示

