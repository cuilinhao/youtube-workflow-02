# 批量文生图系统流程图

## 系统架构流程图

```mermaid
graph TB
    A[用户操作] --> B{选择模式}
    B -->|new| C[筛选等待中的提示词]
    B -->|selected| D[筛选选中的提示词]
    B -->|all| E[选择所有提示词]
    
    C --> F[读取应用数据]
    D --> F
    E --> F
    
    F --> G[解析API配置]
    G --> H[应用风格设置]
    H --> I[收集图片引用]
    I --> J[重置提示词状态]
    
    J --> K[并发处理提示词]
    K --> L[processPrompt函数]
    
    L --> M[应用风格到提示词]
    M --> N[提取图片引用]
    N --> O[构建多模态消息]
    O --> P[调用AI服务]
    
    P --> Q{API调用成功?}
    Q -->|是| R[解析响应内容]
    Q -->|否| S[重试机制]
    S --> T{达到重试上限?}
    T -->|否| P
    T -->|是| U[标记为失败]
    
    R --> V{找到图片数据?}
    V -->|是| W[保存图片文件]
    V -->|否| X[标记为失败]
    
    W --> Y[更新状态为成功]
    U --> Z[更新状态为失败]
    X --> Z
    
    Y --> AA[返回结果]
    Z --> AA
```

## 详细处理流程图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant A as API路由
    participant B as 业务逻辑
    participant D as 数据存储
    participant AI as AI服务
    
    U->>F: 点击批量文生图
    F->>A: POST /api/generate/images
    A->>B: generateImages()
    
    B->>D: readAppData()
    D-->>B: 返回应用数据
    
    B->>B: 筛选目标提示词
    B->>B: 解析API配置
    B->>B: 应用风格设置
    
    B->>D: updateAppData()
    Note over B,D: 重置提示词状态
    
    loop 并发处理每个提示词
        B->>B: processPrompt()
        B->>B: 应用风格
        B->>B: 提取图片引用
        B->>B: 构建消息内容
        
        B->>AI: 调用AI服务
        AI-->>B: 返回响应
        
        alt 成功
            B->>B: 解析图片数据
            B->>B: 保存图片文件
            B->>D: 更新状态为成功
        else 失败
            B->>B: 重试机制
            alt 重试成功
                B->>B: 处理成功流程
            else 重试失败
                B->>D: 更新状态为失败
            end
        end
    end
    
    B-->>A: 返回处理结果
    A-->>F: 返回响应
    F-->>U: 显示结果
```

## 状态流转图

```mermaid
stateDiagram-v2
    [*] --> 等待中
    等待中 --> 生成中: 开始处理
    生成中 --> 下载中: API调用成功
    生成中 --> 失败: API调用失败
    下载中 --> 成功: 图片保存成功
    下载中 --> 失败: 图片保存失败
    失败 --> 等待中: 重新生成
    成功 --> [*]
    失败 --> [*]
```

## 错误处理流程图

```mermaid
graph TD
    A[开始处理] --> B[调用AI服务]
    B --> C{响应状态}
    C -->|200| D[解析响应内容]
    C -->|非200| E[记录错误信息]
    
    D --> F{找到图片数据?}
    F -->|是| G[保存图片文件]
    F -->|否| H[记录解析错误]
    
    G --> I{保存成功?}
    I -->|是| J[更新状态为成功]
    I -->|否| K[记录保存错误]
    
    E --> L{达到重试上限?}
    H --> L
    K --> L
    
    L -->|否| M[等待重试间隔]
    L -->|是| N[更新状态为失败]
    
    M --> B
    J --> O[处理完成]
    N --> O
```

## 并发处理流程图

```mermaid
graph TB
    A[开始批量处理] --> B[获取目标提示词列表]
    B --> C[创建并发限制器]
    C --> D[创建处理任务队列]
    
    D --> E[并发执行任务]
    E --> F[processPrompt 1]
    E --> G[processPrompt 2]
    E --> H[processPrompt N]
    
    F --> I[处理完成 1]
    G --> J[处理完成 2]
    H --> K[处理完成 N]
    
    I --> L[收集所有结果]
    J --> L
    K --> L
    
    L --> M[统计成功/失败数量]
    M --> N[返回最终结果]
```

## 数据流图

```mermaid
graph LR
    A[用户输入] --> B[前端组件]
    B --> C[API调用]
    C --> D[业务逻辑层]
    D --> E[数据存储层]
    D --> F[AI服务层]
    
    E --> G[应用数据]
    E --> H[提示词数据]
    E --> I[风格数据]
    
    F --> J[多平台支持]
    J --> K[云雾AI]
    J --> L[API易]
    J --> M[apicore]
    J --> N[KIE.AI]
    
    D --> O[图片处理]
    O --> P[文件保存]
    P --> Q[状态更新]
    Q --> R[结果返回]
```

## 配置管理流程图

```mermaid
graph TD
    A[读取应用配置] --> B[解析API设置]
    B --> C[获取当前平台]
    C --> D[构建API配置]
    
    D --> E[验证API密钥]
    E --> F{密钥有效?}
    F -->|是| G[使用当前配置]
    F -->|否| H[尝试其他平台]
    
    H --> I{有其他平台?}
    I -->|是| J[切换到备用平台]
    I -->|否| K[返回配置错误]
    
    J --> G
    G --> L[应用并发设置]
    L --> M[应用重试设置]
    M --> N[应用保存路径]
    N --> O[开始处理]
```

这个流程图展示了批量文生图系统的完整处理流程，包括：

1. **系统架构**: 展示了各个组件之间的关系
2. **详细处理流程**: 展示了从用户操作到最终结果的完整过程
3. **状态流转**: 展示了提示词状态的变化过程
4. **错误处理**: 展示了各种错误情况的处理方式
5. **并发处理**: 展示了如何并发处理多个提示词
6. **数据流**: 展示了数据在系统中的流动
7. **配置管理**: 展示了配置的读取和应用过程
